
name: Deploy Api (EC2)

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS region (ej: us-east-1)"
        default: "us-east-1"
        required: true
        type: string
      api_instance_tag_name:
        description: "Tag Name de la instancia EC2 que ejecutará la API"
        default: "graph-routes-api"
        required: true
        type: string
      repo_name:
        description: "Nombre lógico de la imagen/JAR (coincide con REPO_NAME)"
        default: "graph-routes-api"
        required: true
        type: string
      neo4j_uri:
        description: "URI de Neo4j (ej: neo4j://host:7687)"
        default: "neo4j://54.242.215.23:7687"
        required: true
        type: string
      neo4j_user:
        description: "Usuario Neo4j"
        default: "neo4j"
        required: true
        type: string
      create_api:
        description: "Si no existe la instancia, crearla (true/false)"
        default: "true"
        required: true
        type: choice
        options: ["true","false"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    # ⚠️ Define estos secrets/vars en Settings → Secrets and variables → Actions
    env:
      AWS_REGION: ${{ inputs.aws_region }}
      REPO_NAME: ${{ inputs.repo_name }}
      API_INSTANCE_TAG_NAME: ${{ inputs.api_instance_tag_name }}
      CREATE_API: ${{ inputs.create_api }}
      EC2_USER: "ec2-user"

      # Neo4j ⇒ usado por setup_api.sh/contendor
      NEO4J_URI: ${{ inputs.neo4j_uri }}
      NEO4J_USER: ${{ inputs.neo4j_user }}
      NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}

      # (Opcional) despliegue con imagen de registry en vez de build local
      API_IMAGE: ${{ vars.API_IMAGE || '' }}
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Check toolchain
        run: |
          aws --version
          docker version
          docker info
          mvn -v
          ssh -V
          scp -V

      - name: Build API jar (skip tests)
        run: mvn -B -q -DskipTests -pl Api -am package

      - name: Run deploy script
        id: deploy
        run: |
          set -euo pipefail
          # Ejecuta tu script. Éste ya:
          #  - crea/valida KeyPair y .pem
          #  - crea/encuentra EC2 con tag Name=${API_INSTANCE_TAG_NAME}
          #  - copia setup_api.sh + JAR + Dockerfile.local
          #  - lanza el contenedor y hace health-check
          bash scripts/deploy_api.sh

          # Extra: saca la IP pública como output para que se muestre en la UI
          API_IP="$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${API_INSTANCE_TAG_NAME}" "Name=instance-state-name,Values=running" \
            --region "${AWS_REGION}" \
            --query "Reservations[0].Instances[0].PublicIpAddress" --output text)"
          echo "ip=${API_IP}" >> $GITHUB_OUTPUT
          echo "API_IP=${API_IP}" >> $GITHUB_ENV

      - name: Show deployed URL
        run: |
          echo "API health: http://${API_IP}:8080/api/health"
          echo "OpenAPI UI: http://${API_IP}:8080/swagger-ui/index.html"

      - name: Upload setup script (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: setup_api_sh
          path: Api/src/main/resources/setup_api.sh

    outputs:
      api_ip: ${{ steps.deploy.outputs.ip }}
