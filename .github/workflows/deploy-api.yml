
name: Deploy Api (EC2)

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS region (ej: us-east-1)"
        default: "us-east-1"
        required: true
        type: string
      api_instance_tag_name:
        description: "Tag Name de la instancia EC2"
        default: "graph-routes-api-test"
        required: true
        type: string
      repo_name:
        description: "Nombre lógico del despliegue (REPO_NAME)"
        default: "graph-routes-api-test"
        required: true
        type: string
      neo4j_uri:
        description: "URI Neo4j (neo4j://host:7687)"
        default: "neo4j://172.30.48.1:7687"
        required: true
        type: string
      neo4j_user:
        description: "Usuario Neo4j"
        default: "neo4j"
        required: true
        type: string
      create_api:
        description: "Crear instancia si no existe"
        default: "true"
        required: true
        type: choice
        options:
          - "true"
          - "false"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      AWS_REGION: ${{ inputs.aws_region }}
      REPO_NAME: ${{ inputs.repo_name }}
      API_INSTANCE_TAG_NAME: ${{ inputs.api_instance_tag_name }}
      CREATE_API: ${{ inputs.create_api }}
      EC2_USER: ec2-user

      NEO4J_URI: ${{ inputs.neo4j_uri }}
      NEO4J_USER: ${{ inputs.neo4j_user }}
      NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}

      API_IMAGE: ${{ vars.API_IMAGE }}
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      - name: "Pre-check de secrets (temporales STS)"
        shell: bash
        env:
          AKID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          SAK: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          STOK: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          set -euo pipefail
          for v in AKID SAK STOK; do
            if [ -z "${!v}" ]; then
              echo "❌ Falta el secret $v (temporales STS)."
              echo "   Ejecuta: aws sts get-session-token --duration-seconds 3600"
              echo "   y pega AccessKeyId, SecretAccessKey y SessionToken en los secrets."
              exit 1
            fi
          done
          echo "✅ Secrets temporales presentes."

      - name: Checkout
        uses: actions/checkout@v4

      - name: "Configure AWS credentials (Temporary STS)"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: "STS: who am I?"
        run: aws sts get-caller-identity

      - name: "Check toolchain"
        shell: bash
        run: |
          set -euxo pipefail
          aws --version
          docker version
          docker info
          mvn -v
          ssh -V
          # 'scp -V' no existe en OpenSSH; comprobamos binario
          command -v scp >/dev/null

      - name: "Build API jar (skip tests)"
        run: mvn -B -q -DskipTests -pl Api -am package

      - name: "Verify repo layout and script path"
        shell: bash
        run: |
          set -euxo pipefail
          echo "Working dir:"
          pwd
          echo "List root:"
          ls -la
          echo "List Api/:"
          ls -la Api || true
          echo "List Api/scripts/:"
          ls -la Api/scripts || true
          test -f Api/scripts/deploy_api.sh
          chmod +x Api/scripts/deploy_api.sh

      - name: "Run deploy script"
        run: bash Api/scripts/deploy_api.sh

      - name: "Resolve public IP"
        id: resolve_ip
        shell: bash
        run: |
          set -euo pipefail
          API_IP="$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${API_INSTANCE_TAG_NAME}" "Name=instance-state-name,Values=running" \
            --region "${AWS_REGION}" \
            --query "Reservations[0].Instances[0].PublicIpAddress" --output text)"
          echo "ip=${API_IP}" >> "$GITHUB_OUTPUT"
          echo "API_IP=${API_IP}" >> "$GITHUB_ENV"

      - name: "Show deployed URL (health)"
        shell: bash
        run: |
          echo "API health: http://${API_IP}:8080/api/health"

      - name: "Show deployed URL (swagger)"
        shell: bash
        run: |
          echo "OpenAPI UI: http://${API_IP}:8080/swagger-ui/index.html"

      - name: "Upload setup script (on failure)"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: setup_api_sh
          path: Api/src/main/resources/setup_api.sh

    outputs:
      api_ip: ${{ steps.resolve_ip.outputs.ip }}
